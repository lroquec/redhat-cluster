---
- name: Configure watchdog service
  template:
    src: watchdog.conf.j2
    dest: /etc/watchdog.conf
    owner: root
    group: root
    mode: '0644'
  tags: watchdog

- name: Enable and start watchdog service
  systemd:
    name: watchdog
    enabled: yes
    state: started
  tags: watchdog

- name: Create cluster arbitrator script from template
  template:
    src: cluster_arbitrator.sh.j2
    dest: /usr/local/bin/network-watchdog.sh
    owner: root
    group: root
    mode: '0755'
  tags: watchdog

- name: Create watchdog systemd service file
  template:
    src: network-watchdog.service.j2
    dest: /etc/systemd/system/network-watchdog.service
    owner: root
    group: root
    mode: '0644'
  tags: watchdog

- name: Create watchdog systemd timer file
  template:
    src: network-watchdog.timer.j2
    dest: /etc/systemd/system/network-watchdog.timer
    owner: root
    group: root
    mode: '0644'
  tags: watchdog

- name: Create necessary directories and files for watchdog
  file:
    path: "{{ item.path }}"
    state: "{{ item.state }}"
    mode: "{{ item.mode }}"
    owner: root
    group: root
  with_items:
    - { path: "/run/watchdog", state: "directory", mode: '0755' }
    - { path: "/run/watchdog.pid", state: "touch", mode: '0644' }
    - { path: "/var/run/arbitrator-heartbeat", state: "touch", mode: '0644' }
  tags: watchdog

- name: Set SELinux context for watchdog files
  sefcontext:
    target: "{{ item.target }}"
    setype: watchdog_t
    state: present
  with_items:
    - { target: '/run/watchdog.pid' }
    - { target: '/var/run/arbitrator-heartbeat' }
  when: ansible_selinux.status == "enabled"
  tags: watchdog

- name: Apply SELinux context to watchdog files
  command: restorecon -v {{ item }}
  with_items:
    - "/run/watchdog.pid"
    - "/var/run/arbitrator-heartbeat"
  when: ansible_selinux.status == "enabled"
  changed_when: false
  tags: watchdog

- name: Create systemd-tmpfiles configuration for watchdog
  copy:
    content: |
      f /run/watchdog.pid 0644 root root
      f /var/run/arbitrator-heartbeat 0644 root root
    dest: /etc/tmpfiles.d/watchdog-permissions.conf
    owner: root
    group: root
    mode: '0644'
  tags: watchdog

- name: Create systemd override directory for watchdog
  file:
    path: /etc/systemd/system/watchdog.service.d
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags: watchdog

- name: Create systemd override for watchdog
  copy:
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/sbin/watchdog -c /etc/watchdog.conf -v -f
    dest: /etc/systemd/system/watchdog.service.d/override.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart watchdog
  tags: watchdog

- name: Enable and start watchdog timer
  systemd:
    name: network-watchdog.timer
    enabled: yes
    state: started
    daemon_reload: yes
  tags: watchdog
